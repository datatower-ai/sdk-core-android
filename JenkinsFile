pipeline{
 agent any
    environment {
        GRADLE_HOME = "$JENKINS_HOME/.local/softwares/gradle7"
        PATH = "$GRADLE_HOME/bin:$HOME/.cargo/bin:$PATH"
        SLACK_CHANNEL='roiquery-sdks'
        PROJECT_NAME='roiquery-core'
    }

    parameters {
                    string defaultValue: '99.99.99', description: '请输入aar 版本名称(eg: 1.0.25):', name: 'version_name', trim: true
                    string defaultValue: '1000', description: '请输入aar版本号:', name: 'version_code', trim: true
                }

    stages{
        stage("upload maven"){
          steps{
                script{
                      withCredentials([sshUserPrivateKey(credentialsId: 'a222bbc0-adb9-49f4-84e4-28d6a90b0fa0', keyFileVariable: '', usernameVariable: 'xiaosailing@nodetower.com')]) {
                                sh '''#!/bin/bash
                                git config --global user.name "jenkins"
                                git config --global user.email "xiaosailing@nodetower.com"
                                sh ./upload-release-aar.sh ${version_name} ${version_code} 1 ${PROJECT_NAME}'''
                            }
                      }


                }

        }

        stage("Archive the artifacts"){
          steps{
              script{
                echo "${PROJECT_NAME}"
                archiveArtifacts artifacts: "${PROJECT_NAME}/build/outputs/mapping/*/*.txt", followSymlinks: true
              }
                }
        }
    }

     post{
        success{
            echo "success"
            slackSend channel: "${SLACK_CHANNEL}", color: 'good', message: "maven publish success,version is *${version_name}* --${env.JOB_NAME} <${env.BUILD_URL}|#${env.BUILD_NUMBER}>"
        }
        failure{
            echo "failure"
            slackSend channel: "${SLACK_CHANNEL}", color: 'danger', message: "build failure - ${env.JOB_NAME} <${env.BUILD_URL}|#${env.BUILD_NUMBER}>"
        }
        aborted{
            echo "aborted"
            slackSend channel: "${SLACK_CHANNEL}", color: 'warning', message: "build aborted - ${env.JOB_NAME} <${env.BUILD_URL}|#${env.BUILD_NUMBER}>"
        }
    }

}